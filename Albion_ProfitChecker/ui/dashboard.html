<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Albion Blackmarket Reader � Dashboard</title>
  <meta name="description" content="Albion Blackmarket Reader Dashboard � Profitable items, city comparison, silver filters and Black Market insights." />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <link rel="stylesheet" href="dashboard.css" />
  <link rel="stylesheet" href="account-section/account.css" />
</head>
<body class="dashboard">

  <div class="static-bg" id="staticBg"></div>

  <img src="picture/testo ohne background.png" alt="Logo" class="logo-fixed" onclick="window.location.href='/'" />
  <button class="mobile-back" onclick="window.location.href='/'">? Back</button>

  

    <div id="toast" class="toast" style="display:none;"></div>

  <div id="confirmModal" class="modal-overlay" style="display:none;">
    <div class="modal-card">
      <h3>Check your email</h3>
      <p>We sent you a confirmation email. Please verify it before logging in.</p>
      <button id="confirmClose" class="cta">OK</button>
    </div>
  </div>

  <div id="regionModal" class="modal-overlay" style="display:none;">
    <div class="modal-card">
      <h3>Select your data region</h3>
      <p>Please choose which server data you want to load.</p>
      <select id="regionChoice" class="city-select" style="width:100%;margin:10px 0;">
        <option value="us">America</option>
        <option value="eu">Europe</option>
      </select>
      <button id="confirmRegion" class="cta">Continue</button>
    </div>
  </div>

  <!-- TODO: remove demo notice when production data is live -->
  <div id="maintenanceModal" class="modal-overlay" style="display:none;">
    <div class="modal-card">
      <h3>Free Trial</h3>
      <p>This version is running in Free Trial mode. Live data is still being verified, so results may differ from the final release.</p>
      <button id="maintenanceClose" class="cta">OK</button>
    </div>
  </div>

  <div id="accountMount"></div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading data...</div>
  </div>

  <div id="app" class="page" style="display:none;">
    <header class="topbar">
      <a class="topbar-brand" href="/">
        <img src="picture/testo ohne background.png" alt="Logo" class="topbar-logo" />
        <span class="topbar-title">RomulusKings Market Reader</span>
      </a>
      <div class="topbar-search">
        <input id="searchInput" type="search" placeholder="Search markets" aria-label="Search markets" list="searchSuggestions" />
        <datalist id="searchSuggestions"></datalist>
      </div>
      <nav class="topbar-nav" aria-label="Primary">
        <a class="nav-link active" href="#cards">Markets</a>
        <a class="nav-link" href="/#bm-crafter-access" id="premiumLink">Premium+</a>
        <a class="nav-link" href="/community">Community</a>
      </nav>
      <div class="topbar-right">
        <div class="topbar-meta">
          <div class="badge" id="lastUpdated">Last update: --:-- --.--.----</div>
          <div class="pill-row">
            <span class="pill" id="dealsCount">Deals: 0</span>
            <span class="pill">Region: <span id="regionLabel">America</span></span>
          </div>
        </div>
        <div class="account-wrap">
          <button id="accountBtn" class="account-btn" aria-label="Account">
            <img id="avatarIcon" src="picture/accountsymbol.png" alt="Avatar" />
          </button>
        </div>
      </div>
    </header>

    <section class="dash-hero">
      <div class="hero-badge">
        <span class="hero-dot"></span>
        Real-time Arbitrage Engine
      </div>
      <h1>Black Market Profits.<br /><span class="hero-muted">Made Clear.</span></h1>
      <div class="hero-subline">
        <span class="hero-line"></span>
        <p>>= 30% Profit - 14-Day Range - Live Black Market Data</p>
        <span class="hero-line"></span>
      </div>
    </section>

    <div class="kpi-row" id="kpiRow">
      <div class="kpi-card">
        <span class="kpi-label">Live Signals</span>
        <span class="kpi-value" id="kpiDeals">0</span>
      </div>
      <div class="kpi-card">
        <span class="kpi-label">Top Spread</span>
        <span class="kpi-value" id="kpiBest">--</span>
      </div>
      <div class="kpi-card">
        <span class="kpi-label">Median ROI</span>
        <span class="kpi-value" id="kpiAvg">--</span>
      </div>
      <div class="kpi-card">
        <span class="kpi-label">Max Liquidity</span>
        <span class="kpi-value" id="kpiSilver">--</span>
      </div>
    </div>

    <div class="chart-layout">
      <section class="chart-panel">
        <div class="chart-header">
          <div>
            <h2>Institutional Performance Index</h2>
            <p>Aggregate profit yield across all verified market clusters</p>
          </div>
          <div class="chart-meta">
            <span class="chart-pill">Avg Yield <strong id="avgProfitMonth">--</strong></span>
            <span class="chart-pill">Peak <strong id="bestProfitMonth">--</strong></span>
          </div>
        </div>
        <svg id="profitChart" class="profit-chart" viewBox="0 0 600 220" preserveAspectRatio="none" aria-hidden="true">
          <defs>
            <linearGradient id="chartFill" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="rgba(92,240,200,0.35)" />
              <stop offset="100%" stop-color="rgba(92,240,200,0.02)" />
            </linearGradient>
          </defs>
          <path id="chartArea" class="chart-area" d="" />
          <path id="chartLine" class="chart-line" d="" />
          <circle id="chartDot" class="chart-dot" cx="0" cy="0" r="5" />
              </svg>
        <div id="chartTooltip" class="chart-tooltip" aria-hidden="true"></div>
      <div class="chart-controls">
        <div class="range-group" role="group" aria-label="Range">
          <button class="range-btn active" type="button" data-range="1W">1W</button>
          <button class="range-btn" type="button" data-range="1M">1M</button>
          <button class="range-btn" type="button" data-range="6M">6M</button>
          <button class="range-btn" type="button" data-range="1Y">1Y</button>
        </div>
        <div class="chart-actions" aria-hidden="true"></div>
      </div>
    </section>

            <aside class="side-stack">
        <div class="side-card premium-panel">
          <div class="side-card-header">
            <div class="side-card-copy">
              <span class="side-card-label">Premium Feature</span>
              <span class="side-card-title">BM Crafter</span>
            </div>
            <span class="premium-badge">
              <span class="premium-dot" aria-hidden="true"></span>
              New
            </span>
          </div>
          <button class="premium-preview" type="button" id="premiumPreviewBtn" aria-label="Preview BM Crafter">
            <img src="picture/bm-crafter-table.png" alt="BM Crafter preview" />
          </button>
          <a class="premium-button" href="/#bm-crafter-access">Upgrade Now</a>
        </div>
        <div class="side-card city-panel">
          <div class="side-card-header">
            <img id="cityCrest" class="city-crest-img" src="picture/Carleon.png" alt="City crest" />
            <div class="city-panel-copy">
              <span class="city-panel-title">City</span>
              <span class="city-panel-name" id="cityName">All Cities</span>
            </div>
          </div>
          <select id="citySelect" class="city-select">
            <option value="ALL">All Cities</option>
            <option value="Lymhurst">Lymhurst</option>
            <option value="Martlock">Martlock</option>
            <option value="Fort Sterling">Fort Sterling</option>
            <option value="Thetford">Thetford</option>
            <option value="Bridgewatch">Bridgewatch</option>
            <option value="Caerleon">Caerleon</option>
          </select>
        </div>
      </aside>
    </div>

    <div class="chart-divider" aria-hidden="true"></div>

    <section class="cards-section">
      <div class="filters-wrap">
        <div class="filters-bar">
          <div class="tier-filters" role="group" aria-label="Tier filters">
            <button class="tier-btn active" type="button" data-tier="ALL">All tiers</button>
            <button class="tier-btn" type="button" data-tier="T4">Tier 4</button>
            <button class="tier-btn" type="button" data-tier="T5">Tier 5</button>
            <button class="tier-btn" type="button" data-tier="T6">Tier 6</button>
            <button class="tier-btn" type="button" data-tier="T7">Tier 7</button>
            <button class="tier-btn" type="button" data-tier="T8">Tier 8</button>
          </div>
          <div class="filters-right">
            <label class="filter-field" for="minProfit">
              <span>Min Profit %</span>
              <input id="minProfit" type="number" value="0" />
            </label>
            <label class="filter-field" for="maxCost">
              <span>Max Cost per Item</span>
              <input id="maxCost" type="number" placeholder="100000" />
            </label>
            <div class="filter-actions">
              <button id="applyFilter">Apply filter</button>
              <button id="filterSilver">Sort by silver</button>
              <button id="clearSilver" style="display:none;">Reset</button>
            </div>
          </div>
        </div>
      </div>

      <div id="cards" class="grid"></div>
      <div id="loadMoreTrigger"></div>
    </section>

    <a class="community-tile compact" href="/community" aria-label="Join Discord">
      <span class="tile-icon-wrap">
        <svg class="tile-icon" viewBox="0 0 256 199" aria-hidden="true" focusable="false">
          <path d="M216.9 16.5A208.5 208.5 0 0 0 164.6 0c-2.3 4-4.9 9.2-6.7 13.4-19.2-2.9-38.1-2.9-57.1 0-1.8-4.2-4.5-9.4-6.8-13.4a209.3 209.3 0 0 0-52.4 16.5C6.6 68.4-3.1 119.4 1.8 169.8a210.1 210.1 0 0 0 63.9 32.7c5.2-7.1 9.8-14.6 13.5-22.7-7.4-2.8-14.5-6.2-21.2-10.2 1.8-1.3 3.5-2.6 5.1-4 40.9 19.1 85.1 19.1 125.5 0 1.7 1.4 3.4 2.7 5.1 4-6.7 4-13.8 7.4-21.2 10.2 3.7 8.1 8.3 15.6 13.5 22.7a210.2 210.2 0 0 0 63.9-32.7c5.8-57.9-9.7-108.4-44.8-153.3ZM85 135.3c-12.5 0-22.7-11.4-22.7-25.4S72.5 84.5 85 84.5s22.7 11.4 22.7 25.4-10.1 25.4-22.7 25.4Zm86 0c-12.5 0-22.7-11.4-22.7-25.4s10.1-25.4 22.7-25.4 22.7 11.4 22.7 25.4-10.1 25.4-22.7 25.4Z"/>
        </svg>
      </span>
      <span class="tile-copy">
<span class="tile-title">Discord</span>
      </span>
    </a>
  </div><script src="env.js"></script>
  <div id="premiumPreviewModal" class="preview-modal" style="display:none;">
    <div class="preview-card">
      <button id="premiumPreviewClose" class="preview-close" aria-label="Close preview">×</button>
      <img src="picture/bm-crafter-table.png" alt="BM Crafter preview large" />
    </div>
  </div>
  <script type="module">
    let supabase = null;
    const SUPABASE_URL = window.env?.SUPABASE_URL;
    const SUPABASE_ANON_KEY = window.env?.SUPABASE_ANON_KEY;
    if (SUPABASE_URL && SUPABASE_ANON_KEY) {
      try {
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      } catch (_) { /* auth disabled */ }
    }

    const loadingOverlay = document.getElementById('loadingOverlay');
      const app = document.getElementById('app');
      const cardsEl = document.getElementById('cards');
      const loadMoreTrigger = document.getElementById('loadMoreTrigger');
    const minProfitEl = document.getElementById('minProfit');
    const maxCostEl = document.getElementById('maxCost');
    const tierButtons = Array.from(document.querySelectorAll('.tier-btn'));
      const applyFilterEl = document.getElementById('applyFilter');
    const filterSilverEl = document.getElementById('filterSilver');
    const clearSilverEl = document.getElementById('clearSilver');
    const lastUpdatedEl = document.getElementById('lastUpdated');
    const dealsCountEl = document.getElementById('dealsCount');
    const kpiDealsEl = document.getElementById('kpiDeals');
    const kpiBestEl = document.getElementById('kpiBest');
    const kpiAvgEl = document.getElementById('kpiAvg');
    const kpiSilverEl = document.getElementById('kpiSilver');
    const avgProfitMonthEl = document.getElementById('avgProfitMonth');
    const bestProfitMonthEl = document.getElementById('bestProfitMonth');
    const chartLineEl = document.getElementById('chartLine');
    const chartAreaEl = document.getElementById('chartArea');
    const chartSvg = document.getElementById('profitChart');
    const chartDot = document.getElementById('chartDot');
    const chartTooltip = document.getElementById('chartTooltip');
    const rangeButtons = Array.from(document.querySelectorAll('.range-btn'));
    const searchInput = document.getElementById('searchInput');
    const searchSuggestions = document.getElementById('searchSuggestions');
    const citySelectEl = document.getElementById('citySelect');
    const cityNameEl = document.getElementById('cityName');
    const cityCrestEl = document.getElementById('cityCrest');
    const staticBg = document.getElementById('staticBg');
    let regionSelectAccount = null;
    const regionLabel = document.getElementById('regionLabel');
    const regionModal = document.getElementById('regionModal');
    const regionChoice = document.getElementById('regionChoice');
    const confirmRegion = document.getElementById('confirmRegion');
    const maintenanceModal = document.getElementById('maintenanceModal');
    const maintenanceClose = document.getElementById('maintenanceClose');

    const accountBtn = document.getElementById('accountBtn');
    const avatarIcon = document.getElementById('avatarIcon');
    const accountMount = document.getElementById('accountMount');
    let accountPanel = null;
    let accountClose = null;
    let accountEmail = null;
    let profileAvatar = null;
    let resetPw = null;
    let logout = null;
    const confirmModal = document.getElementById('confirmModal');
    const confirmClose = document.getElementById('confirmClose');

    const crestMap = {
      "ALL": "picture/Carleon.png",
      "Lymhurst": "picture/Lymhurstwappen.png",
      "Martlock": "picture/Martlockwappen.png",
      "Fort Sterling": "picture/Fortsterlingwappen.png",
      "Thetford": "picture/Thefortwappen.png",
      "Bridgewatch": "picture/Bridgewatch.png",
      "Caerleon": "picture/Carleon.png"
    };

    const nameMap = {
      "OFF_SHIELD": "Beginner's Shield",
      "OFF_TOWERSHIELD_UNDEAD": "Sarcophagus",
      "OFF_SHIELD_HELL": "Caitiff Shield",
      "OFF_SPIKEDSHIELD_MORGANA": "Facebreaker",
      "OFF_SHIELD_AVALON": "Astral Aegis",
      "OFF_SHIELD_CRYSTAL": "Unbreakable Ward",
      "OFF_BOOK": "Tome of Spells",
      "OFF_ORB_MORGANA": "Eye of Secrets",
      "OFF_DEMONSKULL_HELL": "Muisak",
      "OFF_TOTEM_KEEPER": "Taproot",
      "OFF_CENSER_AVALON": "Celestial Censer",
      "OFF_TOME_CRYSTAL": "Timelocked Grimoire",
      "OFF_TORCH": "Torch",
      "OFF_HORN_KEEPER": "Mistcaller",
      "OFF_TALISMAN_AVALON": "Sacred Scepter",
      "OFF_LAMP_UNDEAD": "Cryptcandle",
      "OFF_JESTERCANE_HELL": "Leering Cane",
      "OFF_TORCH_CRYSTAL": "Blueflame Torch",
      "HEAD_PLATE_SET1": "Soldier Helmet",
      "ARMOR_PLATE_SET1": "Soldier Armor",
      "SHOES_PLATE_SET1": "Soldier Boots",
      "HEAD_PLATE_SET2": "Knight Helmet",
      "ARMOR_PLATE_SET2": "Knight Armor",
      "SHOES_PLATE_SET2": "Knight Boots",
      "HEAD_PLATE_SET3": "Guardian Helmet",
      "ARMOR_PLATE_SET3": "Guardian Armor",
      "SHOES_PLATE_SET3": "Guardian Boots",
      "HEAD_PLATE_UNDEAD": "Graveguard Helmet",
      "ARMOR_PLATE_UNDEAD": "Graveguard Armor",
      "SHOES_PLATE_UNDEAD": "Graveguard Boots",
      "HEAD_PLATE_HELL": "Demon Helmet",
      "ARMOR_PLATE_HELL": "Demon Armor",
      "SHOES_PLATE_HELL": "Demon Boots",
      "HEAD_PLATE_KEEPER": "Judicator Helmet",
      "ARMOR_PLATE_KEEPER": "Judicator Armor",
      "SHOES_PLATE_KEEPER": "Judicator Boots",
      "HEAD_PLATE_FEY": "Duskweaver Helmet",
      "ARMOR_PLATE_FEY": "Duskweaver Armor",
      "SHOES_PLATE_FEY": "Duskweaver Boots",
      "HEAD_PLATE_AVALON": "Helmet of Valor",
      "ARMOR_PLATE_AVALON": "Armor of Valor",
      "SHOES_PLATE_AVALON": "Boots of Valor",
      "HEAD_LEATHER_SET1": "Beginner's Mercenary Hood",
      "ARMOR_LEATHER_SET1": "Beginner's Mercenary Jacket",
      "SHOES_LEATHER_SET1": "Beginner's Mercenary Shoes",
      "HEAD_LEATHER_SET2": "Hunter Hood",
      "ARMOR_LEATHER_SET2": "Hunter Jacket",
      "SHOES_LEATHER_SET2": "Hunter Shoes",
      "HEAD_LEATHER_SET3": "Assassin Hood",
      "ARMOR_LEATHER_SET3": "Assassin Jacket",
      "SHOES_LEATHER_SET3": "Assassin Shoes",
      "HEAD_LEATHER_MORGANA": "Stalker Hood",
      "ARMOR_LEATHER_MORGANA": "Stalker Jacket",
      "SHOES_LEATHER_MORGANA": "Stalker Shoes",
      "HEAD_LEATHER_HELL": "Hellion Hood",
      "ARMOR_LEATHER_HELL": "Hellion Jacket",
      "SHOES_LEATHER_HELL": "Hellion Shoes",
      "HEAD_LEATHER_UNDEAD": "Specter Hood",
      "ARMOR_LEATHER_UNDEAD": "Specter Jacket",
      "SHOES_LEATHER_UNDEAD": "Specter Shoes",
      "HEAD_LEATHER_FEY": "Mistwalker Hood",
      "ARMOR_LEATHER_FEY": "Mistwalker Jacket",
      "SHOES_LEATHER_FEY": "Mistwalker Shoes",
      "HEAD_LEATHER_AVALON": "Hood of Tenacity",
      "ARMOR_LEATHER_AVALON": "Jacket of Tenacity",
      "SHOES_LEATHER_AVALON": "Shoes of Tenacity",
      "HEAD_CLOTH_SET1": "Scholar Cowl",
      "ARMOR_CLOTH_SET1": "Scholar Robe",
      "SHOES_CLOTH_SET1": "Scholar Sandals",
      "HEAD_CLOTH_SET2": "Cleric Cowl",
      "ARMOR_CLOTH_SET2": "Cleric Robe",
      "SHOES_CLOTH_SET2": "Cleric Sandals",
      "HEAD_CLOTH_SET3": "Mage Cowl",
      "ARMOR_CLOTH_SET3": "Mage Robe",
      "SHOES_CLOTH_SET3": "Mage Sandals",
      "HEAD_CLOTH_KEEPER": "Druid Cowl",
      "ARMOR_CLOTH_KEEPER": "Druid Robe",
      "SHOES_CLOTH_KEEPER": "Druid Sandals",
      "HEAD_CLOTH_HELL": "Fiend Cowl",
      "ARMOR_CLOTH_HELL": "Fiend Robe",
      "SHOES_CLOTH_HELL": "Fiend Sandals",
      "HEAD_CLOTH_MORGANA": "Cultist Cowl",
      "ARMOR_CLOTH_MORGANA": "Cultist Robe",
      "SHOES_CLOTH_MORGANA": "Cultist Sandals",
      "HEAD_CLOTH_FEY": "Feyscale Hat",
      "ARMOR_CLOTH_FEY": "Feyscale Robe",
      "SHOES_CLOTH_FEY": "Feyscale Sandals",
      "HEAD_CLOTH_AVALON": "Cowl of Purity",
      "ARMOR_CLOTH_AVALON": "Robe of Purity",
      "SHOES_CLOTH_AVALON": "Sandals of Purity",
      "HEAD_CLOTH_ROYAL": "Royal Cowl",
      "ARMOR_CLOTH_ROYAL": "Royal Robe",
      "SHOES_CLOTH_ROYAL": "Royal Sandals",
      "HEAD_LEATHER_ROYAL": "Royal Hood",
      "ARMOR_LEATHER_ROYAL": "Royal Jacket",
      "SHOES_LEATHER_ROYAL": "Royal Shoes",
      "HEAD_PLATE_ROYAL": "Royal Helmet",
      "ARMOR_PLATE_ROYAL": "Royal Armor",
      "SHOES_PLATE_ROYAL": "Royal Boots",
      "HEAD_GATHERER_FIBER": "Harvester Cap",
      "ARMOR_GATHERER_FIBER": "Harvester Garb",
      "SHOES_GATHERER_FIBER": "Harvester Workboots",
      "HEAD_GATHERER_HIDE": "Skinner Cap",
      "ARMOR_GATHERER_HIDE": "Skinner Garb",
      "SHOES_GATHERER_HIDE": "Skinner Workboots",
      "HEAD_GATHERER_ORE": "Miner Cap",
      "ARMOR_GATHERER_ORE": "Miner Garb",
      "SHOES_GATHERER_ORE": "Miner Workboots",
      "HEAD_GATHERER_ROCK": "Quarrier Cap",
      "ARMOR_GATHERER_ROCK": "Quarrier Garb",
      "SHOES_GATHERER_ROCK": "Quarrier Workboots",
      "HEAD_GATHERER_WOOD": "Lumberjack Cap",
      "ARMOR_GATHERER_WOOD": "Lumberjack Garb",
      "SHOES_GATHERER_WOOD": "Lumberjack Workboots",
      "HEAD_GATHERER_FISH": "Fisherman Cap",
      "ARMOR_GATHERER_FISH": "Fisherman Garb",
      "SHOES_GATHERER_FISH": "Fisherman Workboots",
      "2H_BOW": "Bow",
      "2H_WARBOW": "Warbow",
      "2H_LONGBOW": "Longbow",
      "2H_LONGBOW_UNDEAD": "Whispering Bow",
      "2H_BOW_HELL": "Wailing Bow",
      "2H_BOW_KEEPER": "Bow of Badon",
      "2H_BOW_AVALON": "Mistpiercer",
      "2H_BOW_CRYSTAL": "Skystrider Bow",
      "2H_CROSSBOW": "Crossbow",
      "2H_CROSSBOWLARGE": "Heavy Crossbow",
      "MAIN_1HCROSSBOW": "Light Crossbow",
      "2H_REPEATINGCROSSBOW_UNDEAD": "Weeping Repeater",
      "2H_DUALCROSSBOW_HELL": "Boltcasters",
      "2H_CROSSBOWLARGE_MORGANA": "Siegebow",
      "2H_CROSSBOW_CANNON_AVALON": "Energy Shaper",
      "2H_DUALCROSSBOW_CRYSTAL": "Arclight Blasters",
      "MAIN_CURSEDSTAFF": "Cursed Staff",
      "2H_CURSEDSTAFF": "Great Cursed Staff",
      "2H_DEMONICSTAFF": "Demonic Staff",
      "MAIN_CURSEDSTAFF_UNDEAD": "Lifecurse Staff",
      "2H_SKULLORB_HELL": "Cursed Skull",
      "2H_CURSEDSTAFF_MORGANA": "Damnation Staff",
      "MAIN_CURSEDSTAFF_AVALON": "Shadowcaller",
      "MAIN_CURSEDSTAFF_CRYSTAL": "Rotcaller Staff",
      "MAIN_FIRESTAFF": "Fire Staff",
      "2H_FIRESTAFF": "Great Fire Staff",
      "2H_INFERNOSTAFF": "Infernal Staff",
      "MAIN_FIRESTAFF_KEEPER": "Wildfire Staff",
      "2H_FIRESTAFF_HELL": "Brimstone Staff",
      "2H_INFERNOSTAFF_MORGANA": "Blazing Staff",
      "2H_FIRE_RINGPAIR_AVALON": "Dawnsong",
      "MAIN_FIRESTAFF_CRYSTAL": "Flamewalker Staff",
      "MAIN_FROSTSTAFF": "Frost Staff",
      "2H_FROSTSTAFF": "Great Frost Staff",
      "2H_GLACIALSTAFF": "Glacial Staff",
      "MAIN_FROSTSTAFF_KEEPER": "Hoarfrost Staff",
      "2H_ICEGAUNTLETS_HELL": "Icicle Staff",
      "2H_ICECRYSTAL_UNDEAD": "Permafrost Prism",
      "MAIN_FROSTSTAFF_AVALON": "Chillhowl",
      "2H_FROSTSTAFF_CRYSTAL": "Arctic Staff",
      "MAIN_ARCANESTAFF": "Arcane Staff",
      "2H_ARCANESTAFF": "Great Arcane Staff",
      "2H_ENIGMATICSTAFF": "Enigmatic Staff",
      "MAIN_ARCANESTAFF_UNDEAD": "Witchwork Staff",
      "2H_ARCANESTAFF_HELL": "Occult Staff",
      "2H_ENIGMATICORB_MORGANA": "Malevolent Locus",
      "2H_ARCANE_RINGPAIR_AVALON": "Evensong",
      "2H_ARCANESTAFF_CRYSTAL": "Astral Staff",
      "MAIN_HOLYSTAFF": "Holy Staff",
      "2H_HOLYSTAFF": "Great Holy Staff",
      "2H_DIVINESTAFF": "Divine Staff",
      "MAIN_HOLYSTAFF_MORGANA": "Lifetouch Staff",
      "2H_HOLYSTAFF_HELL": "Fallen Staff",
      "2H_HOLYSTAFF_UNDEAD": "Redemption Staff",
      "MAIN_HOLYSTAFF_AVALON": "Hallowfall",
      "2H_HOLYSTAFF_CRYSTAL": "Exalted Staff",
      "MAIN_NATURESTAFF": "Nature Staff",
      "2H_NATURESTAFF": "Great Nature Staff",
      "2H_WILDSTAFF": "Wild Staff",
      "MAIN_NATURESTAFF_KEEPER": "Druidic Staff",
      "2H_NATURESTAFF_HELL": "Blight Staff",
      "2H_NATURESTAFF_KEEPER": "Rampant Staff",
      "MAIN_NATURESTAFF_AVALON": "Ironroot Staff",
      "MAIN_NATURESTAFF_CRYSTAL": "Forgebark Staff",
      "MAIN_DAGGER": "Dagger",
      "2H_DAGGERPAIR": "Dagger Pair",
      "2H_CLAWPAIR": "Claws",
      "MAIN_RAPIER_MORGANA": "Bloodletter",
      "MAIN_DAGGER_HELL": "Demonfang",
      "2H_IRONGAUNTLETS_HELL": "Black Hands",
      "2H_DUALSICKLE_UNDEAD": "Deathgivers",
      "2H_DAGGER_KATAR_AVALON": "Bridled Fury",
      "2H_DAGGERPAIR_CRYSTAL": "Twin Slayers",
      "MAIN_SPEAR": "Spear",
      "2H_SPEAR": "Pike",
      "2H_GLAIVE": "Glaive",
      "MAIN_SPEAR_KEEPER": "Heron Spear",
      "2H_HARPOON_HELL": "Spirithunter",
      "2H_TRIDENT_UNDEAD": "Trinity Spear",
      "MAIN_SPEAR_LANCE_AVALON": "Daybreaker",
      "2H_GLAIVE_CRYSTAL": "Rift Glaive",
      "MAIN_AXE": "Battleaxe",
      "2H_AXE": "Greataxe",
      "2H_HALBERD": "Halberd",
      "2H_HALBERD_MORGANA": "Carrioncaller",
      "2H_SCYTHE_HELL": "Infernal Scythe",
      "2H_DUALAXE_KEEPER": "Bear Paws",
      "2H_AXE_AVALON": "Realmbreaker",
      "2H_SCYTHE_CRYSTAL": "Crystal Reaper",
      "MAIN_SWORD": "Beginner's Broadsword",
      "2H_CLAYMORE": "Claymore",
      "2H_DUALSWORD": "Dual Swords",
      "MAIN_SCIMITAR_MORGANA": "Clarent Blade",
      "2H_CLEAVER_HELL": "Carving Sword",
      "2H_DUALSCIMITAR_UNDEAD": "Galatine Pair",
      "2H_CLAYMORE_AVALON": "Kingmaker",
      "MAIN_SWORD_CRYSTAL": "Infinity Blade",
      "2H_QUARTERSTAFF": "Quarterstaff",
      "2H_IRONCLADEDSTAFF": "Iron-clad Staff",
      "2H_DOUBLEBLADEDSTAFF": "Double Bladed Staff",
      "2H_COMBATSTAFF_MORGANA": "Black Monk Stave",
      "2H_TWINSCYTHE_HELL": "Soulscythe",
      "2H_ROCKSTAFF_KEEPER": "Staff of Balance",
      "2H_QUARTERSTAFF_AVALON": "Grailseeker",
      "2H_DOUBLEBLADEDSTAFF_CRYSTAL": "Phantom Twinblade",
      "MAIN_HAMMER": "Hammer",
      "2H_POLEHAMMER": "Polehammer",
      "2H_HAMMER": "Great Hammer",
      "2H_HAMMER_UNDEAD": "Tombhammer",
      "2H_DUALHAMMER_HELL": "Forge Hammers",
      "2H_RAM_KEEPER": "Grovekeeper",
      "2H_HAMMER_AVALON": "Hand of Justice",
      "2H_HAMMER_CRYSTAL": "Truebolt Hammer",
      "MAIN_MACE": "Mace",
      "2H_MACE": "Heavy Mace",
      "2H_FLAIL": "Morning Star",
      "MAIN_ROCKMACE_KEEPER": "Bedrock Mace",
      "MAIN_MACE_HELL": "Incubus Mace",
      "2H_MACE_MORGANA": "Camlann Mace",
      "2H_DUALMACE_AVALON": "Oathkeepers",
      "MAIN_MACE_CRYSTAL": "Dreadstorm Monarch",
      "2H_KNUCKLES_SET1": "Brawler Gloves",
      "2H_KNUCKLES_SET2": "Battle Bracers",
      "2H_KNUCKLES_SET3": "Spiked Gauntlets",
      "2H_KNUCKLES_KEEPER": "Ursine Maulers",
      "2H_KNUCKLES_HELL": "Hellfire Hands",
      "2H_KNUCKLES_MORGANA": "Ravenstrike Cestus",
      "2H_KNUCKLES_AVALON": "Fists of Avalon",
      "2H_KNUCKLES_CRYSTAL": "Forcepulse Bracers",
      "2H_SHAPESHIFTER_SET1": "Prowling Staff",
      "2H_SHAPESHIFTER_SET2": "Rootbound Staff",
      "2H_SHAPESHIFTER_SET3": "Primal Staff",
      "2H_SHAPESHIFTER_MORGANA": "Bloodmoon Staff",
      "2H_SHAPESHIFTER_HELL": "Hellspawn Staff",
      "2H_SHAPESHIFTER_KEEPER": "Earthrune Staff",
      "2H_SHAPESHIFTER_AVALON": "Lightcaller",
      "2H_SHAPESHIFTER_CRYSTAL": "Stillgaze Staff"
    };

    const bgMap = {
      "ALL": "radial-gradient(circle at 20% 30%, rgba(92,240,200,0.14), transparent 40%), radial-gradient(circle at 80% 20%, rgba(125,211,255,0.12), transparent 35%), radial-gradient(circle at 60% 80%, rgba(92,240,200,0.10), transparent 40%), linear-gradient(180deg, #0a0d14, #080b12)",
      "Lymhurst": "radial-gradient(circle at 20% 30%, rgba(92,240,200,0.18), transparent 40%), radial-gradient(circle at 80% 20%, rgba(92,240,200,0.10), transparent 35%), linear-gradient(180deg, #0b0f15, #090c12)",
      "Martlock": "radial-gradient(circle at 20% 30%, rgba(94,199,255,0.18), transparent 40%), radial-gradient(circle at 80% 20%, rgba(118,187,255,0.12), transparent 35%), linear-gradient(180deg, #0b0f15, #0a0d14)",
      "Fort Sterling": "radial-gradient(circle at 20% 30%, rgba(255,255,255,0.16), transparent 42%), radial-gradient(circle at 75% 20%, rgba(180,180,180,0.08), transparent 35%), linear-gradient(180deg, #0b0f15, #090c12)",
      "Thetford": "radial-gradient(circle at 20% 30%, rgba(158,117,255,0.16), transparent 42%), radial-gradient(circle at 75% 20%, rgba(118,87,255,0.10), transparent 35%), linear-gradient(180deg, #0b0f15, #090c12)",
      "Bridgewatch": "radial-gradient(circle at 20% 30%, rgba(255,170,92,0.18), transparent 42%), radial-gradient(circle at 75% 20%, rgba(255,140,60,0.10), transparent 35%), linear-gradient(180deg, #0b0f15, #090c12)",
      "Caerleon": "radial-gradient(circle at 20% 30%, rgba(30,30,30,0.22), transparent 42%), radial-gradient(circle at 75% 20%, rgba(0,0,0,0.14), transparent 35%), linear-gradient(180deg, #0b0f15, #080b12)"
    };

    const allowedAvatars = new Set([
      "picture/accountsymbol.png",
      "picture/Bridgewatch.png",
      "picture/Carleon.png",
      "picture/Martlockwappen.png",
      "picture/Lymhurstwappen.png",
      "picture/Thefortwappen.png"
    ]);

    async function loadAvatar() {
      const cachedAvatar = localStorage.getItem("avatar");
      const avatar = sanitizeAvatarUrl(cachedAvatar || "picture/accountsymbol.png");
      if (avatarIcon) avatarIcon.src = avatar;
      if (profileAvatar) profileAvatar.src = avatar;
      if (accountEmail) accountEmail.textContent = "Guest";
      if (supabase) {
        try {
          const { data } = await supabase.auth.getUser();
          if (data?.user) {
            if (accountEmail) accountEmail.textContent = data.user.email || "-";
            const metaAvatar = data.user.user_metadata?.avatar || data.user.user_metadata?.avatar_url || data.user.user_metadata?.picture;
            const av = sanitizeAvatarUrl(metaAvatar || "picture/accountsymbol.png");
            localStorage.setItem("avatar", av);
            if (avatarIcon) avatarIcon.src = av;
            if (profileAvatar) profileAvatar.src = av;
          }
        } catch (_) { /* no auth */ }
      }
    }

    let accountHandlersBound = false;

    async function loadAccountPanel() {
      if (!accountMount) return;
      try {
        const res = await fetch(`account-section/account.html?v=${Date.now()}`);
        if (!res.ok) return;
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, "text/html");
        accountMount.replaceChildren(...doc.body.childNodes);
        accountPanel = document.getElementById('accountPanel');
        accountClose = document.getElementById('accountClose');
        accountEmail = document.getElementById('accountEmail');
        profileAvatar = document.getElementById('profileAvatar');
        regionSelectAccount = document.getElementById('regionSelectAccount');
        resetPw = document.getElementById('resetPw');
        logout = document.getElementById('logout');
        bindAccountHandlers();
      } catch (err) {
        console.error("Account panel failed to load.", err);
      }
    }

    function bindAccountHandlers() {
      if (accountHandlersBound || !accountPanel) return;
      accountHandlersBound = true;

      accountBtn.onclick = () => {
        document.body.classList.add("panel-open");
        accountPanel.classList.add("open");
      };
      if (accountClose) {
        accountClose.onclick = () => {
          document.body.classList.remove("panel-open");
          accountPanel.classList.remove("open");
        };
      }
      if (resetPw) {
        resetPw.style.display = supabase ? "" : "none";
        if (supabase) resetPw.onclick = async () => {
          const user = (await supabase.auth.getUser()).data.user;
          if (!user?.email) return;
          await supabase.auth.resetPasswordForEmail(user.email);
          showToast(`Reset-Link wurde an ${user.email} gesendet.`);
          document.body.classList.remove("panel-open");
          accountPanel.classList.remove("open");
          await supabase.auth.signOut();
          showToast("Password reset link sent.");
        };
      }
      if (logout) {
        logout.style.display = supabase ? "" : "none";
        if (supabase) logout.onclick = async () => {
          const user = (await supabase.auth.getUser()).data.user;
          if (user?.email) showToast(`Logout: ${user.email}`);
          await supabase.auth.signOut();
          document.body.classList.remove("panel-open");
          accountPanel.classList.remove("open");
        };
      }
      if (regionSelectAccount) {
        regionSelectAccount.onchange = (e) => changeRegion(e.target.value);
      }
      accountPanel.querySelectorAll(".avatar-grid img").forEach((img) => {
        img.addEventListener("click", async () => {
          const avatar = sanitizeAvatarSelection(img.getAttribute("data-avatar") || img.src);
          if (supabase) {
            const { data } = await supabase.auth.getUser();
            if (data?.user) await supabase.auth.updateUser({ data: { avatar } });
          }
          localStorage.setItem("avatar", avatar);
          broadcastAvatar(avatar);
          if (avatarIcon) avatarIcon.src = avatar;
          if (profileAvatar) profileAvatar.src = avatar;
        });
      });

      document.addEventListener("click", (e) => {
        if (!accountPanel.contains(e.target) && !accountBtn.contains(e.target)) {
          document.body.classList.remove("panel-open");
          accountPanel.classList.remove("open");
        }
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          document.body.classList.remove("panel-open");
          accountPanel.classList.remove("open");
        }
      });
    }

      let allData = [];
    let minProfitFilter = 0;
    let maxCostFilter = null;
      let sortBySilver = false;
      let tierFilter = "ALL";
      let searchTerm = "";
      let regionCurrent = localStorage.getItem("region") || null;
      let cityFilter = "ALL";
      let currentList = [];
      let visibleCount = 0;
      const batchSize = 60;
      let listObserver = null;

    function setBg(city) {
      staticBg.style.background = bgMap[city] || bgMap.ALL;
    }

    function normalizeName(value) {
      return (value || "").toLowerCase().replace(/\s+/g, " ").trim();
    }

    function sanitizeAvatarUrl(value) {
      const fallback = "picture/accountsymbol.png";
      if (!value || typeof value !== "string") return fallback;
      const trimmed = value.trim();
      if (!trimmed) return fallback;
      if (/^(javascript|data|vbscript|file):/i.test(trimmed)) return fallback;
      try {
        const url = new URL(trimmed, window.location.origin);
        if (url.protocol === "http:" || url.protocol === "https:" || url.protocol === "blob:") {
          return url.href;
        }
        if (url.protocol === "file:") return fallback;
      } catch (_) {
        if (trimmed.startsWith("//")) return fallback;
        return trimmed;
      }
      return fallback;
    }

    function sanitizeAvatarSelection(value) {
      const fallback = "picture/accountsymbol.png";
      if (!value || typeof value !== "string") return fallback;
      const trimmed = value.trim();
      if (!trimmed) return fallback;
      if (allowedAvatars.has(trimmed)) return trimmed;
      try {
        const url = new URL(trimmed, window.location.origin);
        const normalized = url.pathname.replace(/^\/+/, "");
        if (allowedAvatars.has(normalized)) return normalized;
      } catch (_) {
        // ignore invalid URL
      }
      return fallback;
    }

    function baseName(id) {
      const baseNoEnchant = id.split("@")[0];
      const parts = baseNoEnchant.split("_");
      if (parts.length < 2) return id;
      const key = parts.slice(1).join("_");
      return nameMap[key] || key.replace(/_/g, " ");
    }

    function displayName(id) {
      const baseNoEnchant = id.split("@")[0];
      const parts = baseNoEnchant.split("_");
      if (parts.length < 2) return id;
      const tier = parts[0].replace("T", "");
      const enchantMatch = id.match(/@([0-4])/);
      const ench = enchantMatch ? "." + enchantMatch[1] : "";
      const key = parts.slice(1).join("_"); // ohne Tier
      const translated = nameMap[key] || key.replace(/_/g, " ");
      return `${tier}${ench}\u00A0\u00A0${translated}`;
    }

    function updateSuggestions(list) {
      if (!searchSuggestions) return { list: [], map: new Map() };
      const map = new Map();
      for (const item of list) {
        const name = baseName(item.id);
        const key = normalizeName(name);
        if (!map.has(key)) map.set(key, name);
      }
      const values = Array.from(map.values()).sort((a, b) => a.localeCompare(b));
      searchSuggestions.replaceChildren();
      for (const name of values) {
        const option = document.createElement("option");
        option.value = name;
        searchSuggestions.appendChild(option);
      }
      return { list: values, map };
    }

    function buildCard(item) {
      const profitText = sortBySilver
        ? `Profit: ${(item.bm - item.lym).toLocaleString('de-DE')} Silber`
        : `Profit: ${item.profit.toFixed(1)}%`;

      const enchantClass = item.id.includes("@1") ? "border-enchant-1"
        : item.id.includes("@2") ? "border-enchant-2"
        : item.id.includes("@3") ? "border-enchant-3"
        : item.id.includes("@4") ? "border-enchant-4"
        : "";

      const card = document.createElement("div");
      card.className = `card ${enchantClass}`.trim();

      const title = document.createElement("div");
      title.className = "title";
      title.textContent = displayName(item.id);
      card.appendChild(title);

      const addRow = (label, value) => {
        const row = document.createElement("div");
        row.className = "row";
        const labelEl = document.createElement("span");
        labelEl.textContent = label;
        const valueEl = document.createElement("span");
        valueEl.className = "val";
        valueEl.textContent = value;
        row.appendChild(labelEl);
        row.appendChild(valueEl);
        card.appendChild(row);
      };

      addRow("ID", item.id);
      addRow(item.city, item.lym.toLocaleString("de-DE"));
      addRow("Black Market", item.bm.toLocaleString("de-DE"));
      addRow("Sold/Tag", String(item.sold ?? 0));

      const profit = document.createElement("div");
      profit.className = "profit";
      profit.textContent = `${profitText} `;
      const pill = document.createElement("span");
      pill.className = "pill";
      pill.textContent = item.span;
      profit.appendChild(pill);
      card.appendChild(profit);

      return card;
    }

    function renderBatch() {
      const next = currentList.slice(visibleCount, visibleCount + batchSize);
      for (const item of next) {
        cardsEl.appendChild(buildCard(item));
      }
      visibleCount += next.length;
      if (visibleCount >= currentList.length && listObserver) {
        listObserver.disconnect();
      }
    }

    function setupObserver() {
      if (listObserver) listObserver.disconnect();
      listObserver = new IntersectionObserver((entries) => {
        if (entries.some((entry) => entry.isIntersecting)) {
          renderBatch();
        }
      }, { rootMargin: "600px 0px" });
      listObserver.observe(loadMoreTrigger);
    }

    function render() {
      cardsEl.replaceChildren();
      let filtered = allData.filter(item =>
        item.profit >= minProfitFilter &&
        (cityFilter === "ALL" || item.city === cityFilter)
      );
      if (tierFilter !== "ALL") {
        const prefix = `${tierFilter}_`;
        filtered = filtered.filter((item) => (item.id || "").startsWith(prefix));
      }
      if (maxCostFilter !== null) {
        filtered = filtered.filter((item) => {
          const cost = Number(item.lym || 0);
          return cost > 0 && cost <= maxCostFilter;
        });
      }

      const suggestions = updateSuggestions(filtered);
      const term = normalizeName(searchTerm);
      if (term) {
        const isExactBase = suggestions.map.has(term);
        filtered = filtered.filter((item) => {
          const base = normalizeName(baseName(item.id));
          const display = normalizeName(displayName(item.id));
          const id = normalizeName(item.id);
          if (isExactBase) return base === term;
          return base.includes(term) || display.includes(term) || id.includes(term);
        });
      }

      currentList = sortBySilver
        ? [...filtered].sort((a, b) => (b.bm - b.lym) - (a.bm - a.lym))
        : filtered;

      dealsCountEl.textContent = `Deals: ${currentList.length}`;
      if (kpiDealsEl) kpiDealsEl.textContent = currentList.length.toLocaleString("de-DE");

      if (!currentList.length) {
        if (kpiBestEl) kpiBestEl.textContent = "--";
        if (kpiAvgEl) kpiAvgEl.textContent = "--";
        if (kpiSilverEl) kpiSilverEl.textContent = "--";
      } else {
        let bestProfit = -Infinity;
        let totalProfit = 0;
        let bestSilver = -Infinity;
        for (const item of currentList) {
          if (item.profit > bestProfit) bestProfit = item.profit;
          totalProfit += item.profit;
          const silver = item.bm - item.lym;
          if (silver > bestSilver) bestSilver = silver;
        }
        const avgProfit = totalProfit / currentList.length;
        if (kpiBestEl) kpiBestEl.textContent = `${bestProfit.toFixed(1)}%`;
        if (kpiAvgEl) kpiAvgEl.textContent = `${avgProfit.toFixed(1)}%`;
        if (kpiSilverEl) kpiSilverEl.textContent = bestSilver.toLocaleString("de-DE");
      }
      updateChartFromHistory();
      visibleCount = 0;
      setupObserver();
      renderBatch();
    }

    const chartState = {
      buckets: [],
      coords: [],
      dates: []
    };

    let chartRange = "1W";

    function getRangeDays(range) {
      switch (range) {
        case "1M": return 30;
        case "6M": return 180;
        case "1Y": return 365;
        case "1W":
        default:
          return 7;
      }
    }

    function formatDayKey(date) {
      return date.toISOString().slice(0, 10);
    }

    let historyCache = null;

    async function loadHistoryFile() {
      if (historyCache) return historyCache;
      try {
        const res = await fetch(`/avg-profit-history.json?v=${Date.now()}`);
        if (!res.ok) return null;
        historyCache = await res.json();
        return historyCache;
      } catch (_) {
        return null;
      }
    }

    function getHistoryList() {
      if (!historyCache) return [];
      const regionBlock = historyCache[regionCurrent] || {};
      return regionBlock[cityFilter] || regionBlock.ALL || [];
    }

    function buildSeries(days) {
      const today = new Date();
      const history = getHistoryList();
      const map = new Map(history.map((entry) => [entry.date, entry.avg]));
      const values = [];
      const dates = [];
      for (let i = days - 1; i >= 0; i -= 1) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const key = formatDayKey(d);
        dates.push(key);
        values.push(Number.isFinite(map.get(key)) ? map.get(key) : 0);
      }
      return { values, dates };
    }

    function calcStats(values) {
      const usable = values.filter((v) => Number.isFinite(v) && v !== 0);
      const base = usable.length ? usable : values.filter((v) => Number.isFinite(v));
      if (!base.length) return { avg: 0, best: 0 };
      const avg = base.reduce((sum, v) => sum + v, 0) / base.length;
      const best = Math.max(...base);
      return { avg, best };
    }

    function updateChartFromHistory() {
      const series = buildSeries(getRangeDays(chartRange));
      chartState.dates = series.dates;
      updateChart(series.values);
      const stats = calcStats(series.values);
      if (avgProfitMonthEl) avgProfitMonthEl.textContent = `${stats.avg.toFixed(1)}%`;
      if (bestProfitMonthEl) bestProfitMonthEl.textContent = `${stats.best.toFixed(1)}%`;
    }

    function updateChart(list) {
      if (!chartLineEl || !chartAreaEl) return;
      const width = 600;
      const height = 220;
      const pad = 18;
      const values = Array.isArray(list) ? list.filter((v) => Number.isFinite(v)) : [];
      if (!values.length) {
        const y = height / 2;
        const line = `M0,${y} L${width},${y}`;
        const area = `M0,${y} L${width},${y} L${width},${height} L0,${height} Z`;
        chartLineEl.setAttribute("d", line);
        chartAreaEl.setAttribute("d", area);
        chartState.buckets = [];
        chartState.coords = [];
        chartState.dates = [];
        if (chartDot) chartDot.style.opacity = "0";
        if (chartTooltip) chartTooltip.style.display = "none";
        return;
      }

      let min = Math.min(...values);
      let max = Math.max(...values);
      if (min === max) {
        min -= 1;
        max += 1;
      }

      const count = values.length;
      const step = count > 1 ? width / (count - 1) : 0;
      const coords = values.map((val, i) => {
        const x = i * step;
        const t = (val - min) / (max - min);
        const y = pad + (1 - t) * (height - pad * 2);
        return [x, y];
      });

      const line = `M${coords.map(([x, y]) => `${x.toFixed(2)},${y.toFixed(2)}`).join(" L")}`;
      const area = `${line} L${width},${height} L0,${height} Z`;
      chartLineEl.setAttribute("d", line);
      chartAreaEl.setAttribute("d", area);
      chartState.buckets = values;
      chartState.coords = coords;
      if (chartDot) chartDot.style.opacity = "0";
      if (chartTooltip) chartTooltip.style.display = "none";
    }

    function showChartTooltip(index, rect) {
      if (!chartDot || !chartTooltip) return;
      const coords = chartState.coords;
      const buckets = chartState.buckets;
      if (!coords.length || !buckets.length) return;

      const clamped = Math.max(0, Math.min(index, coords.length - 1));
      const value = buckets[clamped];
      const [cx, cy] = coords[clamped];

      chartDot.setAttribute("cx", cx.toFixed(2));
      chartDot.setAttribute("cy", cy.toFixed(2));
      chartDot.style.opacity = "1";

      const dateLabel = chartState.dates[clamped] || `Day ${clamped + 1}`;
      chartTooltip.textContent = `${dateLabel}: ${value.toFixed(1)}%`;

      const panel = chartSvg.closest(".chart-panel");
      if (!panel) return;
      const panelRect = panel.getBoundingClientRect();
      const xPx = rect.left + (cx / 600) * rect.width;
      const yPx = rect.top + (cy / 220) * rect.height;

      chartTooltip.style.left = `${xPx - panelRect.left}px`;
      chartTooltip.style.top = `${yPx - panelRect.top - 12}px`;
      chartTooltip.style.display = "block";
    }

    if (chartSvg) {
      chartSvg.addEventListener("mousemove", (event) => {
        if (!chartState.coords.length) return;
        const rect = chartSvg.getBoundingClientRect();
        const x = Math.max(0, Math.min(event.clientX - rect.left, rect.width));
        const ratio = rect.width ? x / rect.width : 0;
        const index = Math.round(ratio * (chartState.coords.length - 1));
        showChartTooltip(index, rect);
      });
      chartSvg.addEventListener("mouseleave", () => {
        if (chartDot) chartDot.style.opacity = "0";
        if (chartTooltip) chartTooltip.style.display = "none";
      });
    }

    rangeButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        rangeButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        chartRange = btn.dataset.range || "1W";
        const series = buildSeries(getRangeDays(chartRange));
        chartState.dates = series.dates;
        updateChart(series.values);
        const stats = calcStats(series.values);
        if (avgProfitMonthEl) avgProfitMonthEl.textContent = `${stats.avg.toFixed(1)}%`;
        if (bestProfitMonthEl) bestProfitMonthEl.textContent = `${stats.best.toFixed(1)}%`;
      });
    });

    async function loadResults(region = regionCurrent) {
      // Load only the files for the selected region. If none load, leave data empty.
      const files = region === "eu"
        ? ["/results-eu.js", "/results-eu-1.js", "/results-eu-2.js"]
        : ["/results.js", "/results-1.js", "/results-2.js"];

      window.results = [];
      allData = [];

      for (const file of files) {
        try {
          window.results = []; // reset before trying each file
          await new Promise((resolve, reject) => {
      const s = document.createElement("script");
      s.src = `${file}?v=${Date.now()}`;
      s.onload = resolve;
      s.onerror = reject;
      document.body.appendChild(s);
          });
          allData = window.results || [];
          if (allData.length) return;
        } catch (_) {
          // try next file
        }
      }
      // nothing loaded -> keep empty
    }

    function renderLastUpdated(text) {
      const parts = text.trim().split(/\s+/);
      const time = parts[0] || "";
      const date = parts[1] || "";
      lastUpdatedEl.replaceChildren();
      const label = document.createTextNode("Last updated: ");
      const timeSpan = document.createElement("span");
      timeSpan.className = "lu-time";
      timeSpan.textContent = time;
      const space = document.createTextNode(" ");
      const dateSpan = document.createElement("span");
      dateSpan.className = "lu-date";
      dateSpan.textContent = date;
      lastUpdatedEl.append(label, timeSpan, space, dateSpan);
    }

    function setLastUpdated(text) {
      renderLastUpdated(text);
      localStorage.setItem("lastUpdatedText", text);
    }

    function showToast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.style.display = 'block';
      el.classList.add('visible');
      setTimeout(() => el.classList.remove('visible'), 4000);
      setTimeout(() => { el.style.display = 'none'; }, 4500);
    }

    function loadStoredTimestamp() {
      const val = localStorage.getItem("lastUpdatedText");
      if (val) renderLastUpdated(val);
    }

    const regionChannel = ("BroadcastChannel" in window)
      ? new BroadcastChannel("rk-region-sync")
      : null;
    const profileChannel = ("BroadcastChannel" in window)
      ? new BroadcastChannel("rk-profile-sync")
      : null;
    let isSyncingRegion = false;
    let isSyncingAvatar = false;

    function broadcastRegion(region) {
      if (!regionChannel) return;
      regionChannel.postMessage({ type: "region", value: region });
    }
    function broadcastAvatar(avatar) {
      if (!profileChannel) return;
      profileChannel.postMessage({ type: "avatar", value: avatar });
    }

    function setRegion(region) {
      regionCurrent = region === "eu" ? "eu" : "us";
      localStorage.setItem("region", regionCurrent);
      if (regionLabel) regionLabel.textContent = regionCurrent === "eu" ? "Europe" : "America";
      if (regionSelectAccount) regionSelectAccount.value = regionCurrent;
    }

    async function saveRegionToProfile() {
      if (!supabase) return;
      try {
        const { data } = await supabase.auth.getUser();
        if (!data?.user) return;
        await supabase.auth.updateUser({ data: { region: regionCurrent } });
      } catch (_) {
        // ignore profile save errors
      }
    }

    async function changeRegion(region, { broadcast = true } = {}) {
      loadingOverlay.style.display = "flex";
      setRegion(region);
      allData = [];
      render();
      try {
        await loadResults(regionCurrent);
        await loadHistoryFile();
        await saveRegionToProfile();
        const stamp = formatDate(new Date());
        setLastUpdated(stamp);
        render();
        if (broadcast) broadcastRegion(regionCurrent);
      } catch (err) {
        console.error(err);
          showToast("Could not load data for the selected region.");
          setLastUpdated("--:-- --.--.----");
        } finally {
          loadingOverlay.style.display = "none";
        }
      }

    function setCity(city) {
      cityFilter = city;
      cityNameEl.textContent = city === "ALL" ? "All Cities" : city;
      cityCrestEl.src = crestMap[city] || crestMap.ALL;
      setBg(city);
      render();
    }

    async function ensureAuth() {
      app.style.display = "block";
      const cachedRegion = localStorage.getItem("region");
      let userRegion = null;
      if (supabase) try {
        userRegion = (await supabase.auth.getUser()).data?.user?.user_metadata?.region;
      } catch (_) { supabase = null; }
      const savedRegion = cachedRegion || userRegion || "us";
      setRegion(savedRegion);
      return true;
    }

    function formatDate(dt) {
      const d = dt.getDate().toString().padStart(2, "0");
      const m = (dt.getMonth() + 1).toString().padStart(2, "0");
      const y = dt.getFullYear();
      const h = dt.getHours().toString().padStart(2, "0");
      const min = dt.getMinutes().toString().padStart(2, "0");
      return `${h}:${min}  ${d}.${m}.${y}`;
    }

    async function initApp() {
      loadingOverlay.style.display = "flex";
      try {
        await loadResults(regionCurrent);
        await loadHistoryFile();
        const stamp = formatDate(new Date());
        setLastUpdated(stamp);
        render();
      } catch (err) {
        console.error(err);
        showToast("Data could not be loaded. Check results.js / results-eu.js.");
      } finally {
        loadingOverlay.style.display = "none";
      }
    }

    function setTierFilter(value) {
      tierFilter = value || "ALL";
      tierButtons.forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.tier === tierFilter);
      });
      minProfitFilter = Number(minProfitEl.value) || 0;
      const rawCost = Number(maxCostEl.value);
      maxCostFilter = Number.isFinite(rawCost) && rawCost > 0 ? rawCost : null;
      render();
    }

    applyFilterEl.onclick = () => {
      minProfitFilter = Number(minProfitEl.value) || 0;
      const rawCost = Number(maxCostEl.value);
      maxCostFilter = Number.isFinite(rawCost) && rawCost > 0 ? rawCost : null;
      render();
    };
    tierButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        setTierFilter(btn.dataset.tier || "ALL");
      });
    });
    if (minProfitEl) {
      minProfitEl.addEventListener("keydown", (event) => {
        if (event.key === "Enter") applyFilterEl.click();
      });
    }
    if (maxCostEl) {
      maxCostEl.addEventListener("keydown", (event) => {
        if (event.key === "Enter") applyFilterEl.click();
      });
    }
    filterSilverEl.onclick = () => { sortBySilver = true; clearSilverEl.style.display = "inline-block"; render(); };
    clearSilverEl.onclick = () => { sortBySilver = false; clearSilverEl.style.display = "none"; render(); };
    if (searchInput) {
      searchInput.addEventListener("input", (event) => {
        searchTerm = event.target.value || "";
        render();
      });
    }
    citySelectEl.onchange = (e) => setCity(e.target.value);

    if (confirmClose) confirmClose.onclick = () => { confirmModal.style.display = "none"; };

    const topbarEl = document.querySelector(".topbar");
    const heroEl = document.querySelector(".dash-hero");
    let lastScrollY = window.scrollY;
    let ticking = false;
    const updateTopbar = () => {
      const currentY = window.scrollY;
      const heroLimit = heroEl
        ? (heroEl.offsetTop + heroEl.offsetHeight - 20)
        : 120;
      if (!topbarEl) return;
      if (currentY < heroLimit) {
        topbarEl.classList.remove("topbar-hidden");
      } else {
        topbarEl.classList.add("topbar-hidden");
      }
      lastScrollY = currentY;
      ticking = false;
    };
    window.addEventListener("scroll", () => {
      if (!ticking) {
        window.requestAnimationFrame(updateTopbar);
        ticking = true;
      }
    });

    const premiumPreviewBtn = document.getElementById("premiumPreviewBtn");
    const premiumPreviewModal = document.getElementById("premiumPreviewModal");
    const premiumPreviewClose = document.getElementById("premiumPreviewClose");

    if (premiumPreviewBtn && premiumPreviewModal) {
      premiumPreviewBtn.addEventListener("click", () => {
        premiumPreviewModal.style.display = "flex";
      });
    }
    if (premiumPreviewClose && premiumPreviewModal) {
      premiumPreviewClose.addEventListener("click", () => {
        premiumPreviewModal.style.display = "none";
      });
    }
    if (premiumPreviewModal) {
      premiumPreviewModal.addEventListener("click", (event) => {
        if (event.target === premiumPreviewModal) {
          premiumPreviewModal.style.display = "none";
        }
      });
    }

    if (regionCurrent) setRegion(regionCurrent);

    if (regionChannel) {
      regionChannel.onmessage = (event) => {
        const next = (event.data && event.data.value) || "";
        if (next !== "us" && next !== "eu") return;
        if (next === regionCurrent) return;
        if (isSyncingRegion) return;
        isSyncingRegion = true;
        changeRegion(next, { broadcast: false }).finally(() => {
          isSyncingRegion = false;
        });
      };
    }
    if (profileChannel) {
      profileChannel.onmessage = (event) => {
        const next = (event.data && event.data.value) || "";
        if (!next) return;
        if (isSyncingAvatar) return;
        isSyncingAvatar = true;
        const safe = sanitizeAvatarUrl(next || "picture/accountsymbol.png");
        localStorage.setItem("avatar", safe);
        if (avatarIcon) avatarIcon.src = safe;
        if (profileAvatar) profileAvatar.src = safe;
        isSyncingAvatar = false;
      };
    }

    window.addEventListener("storage", (event) => {
      if (event.key !== "region") return;
      const next = (event.newValue || "").toLowerCase();
      if (next !== "us" && next !== "eu") return;
      if (next === regionCurrent) return;
      if (isSyncingRegion) return;
      isSyncingRegion = true;
      changeRegion(next, { broadcast: false }).finally(() => {
        isSyncingRegion = false;
      });
    });
    window.addEventListener("storage", (event) => {
      if (event.key !== "avatar") return;
      const next = event.newValue || "";
      if (!next) return;
      if (isSyncingAvatar) return;
      isSyncingAvatar = true;
      const safe = sanitizeAvatarUrl(next || "picture/accountsymbol.png");
      if (avatarIcon) avatarIcon.src = safe;
      if (profileAvatar) profileAvatar.src = safe;
      isSyncingAvatar = false;
    });

    (async () => {
      await loadAccountPanel();
      const ok = await ensureAuth();
      if (ok) {
        await loadAvatar();
        await initApp();
        sessionStorage.removeItem("freshLoginReloadDone");
        setCity("ALL");
      }
      confirmRegion.onclick = async () => {
        setRegion(regionChoice.value);
        await saveRegionToProfile();
        regionModal.style.display = "none";
        app.style.display = "block";
        await loadAvatar();
        await loadHistoryFile();
        await initApp();
        sessionStorage.removeItem("freshLoginReloadDone");
        setCity("ALL");
      };

      // show maintenance info (remove when done)
      maintenanceModal.style.display = "flex";
      maintenanceClose.onclick = () => { maintenanceModal.style.display = "none"; };
    })();
  </script>
  <script defer src="/_vercel/insights/script.js"></script>
  <script defer src="/_vercel/speed-insights/script.js"></script>
</body>
</html>
































