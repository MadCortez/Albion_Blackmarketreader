name: Build Artefact Prices (EU + US)

on:
  workflow_dispatch:
  schedule:
    - cron: "20 9 * * *"

permissions:
  contents: write

jobs:
  build-artefact-prices:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch artefact prices (Lymhurst only)
        run: |
          node - <<'NODE'
          const fs = require("fs");
          const path = require("path");

          const idsPath = path.join(process.cwd(), "artefact-ids-only.json");
          const idsFallback = path.join(process.cwd(), "Albion_ProfitChecker", "artefact-ids-only.json");
          const outputDir = path.join("Albion_ProfitChecker", "ui", "Blackmarket-Crafter", "data");
          const cities = ["Lymhurst", "Caerleon", "Bridgewatch", "Martlock", "Fort Sterling", "Thetford"];
          const chunkSize = 50;
          const historyChunkSize = 20;
          const delayMs = 1500;

          const regions = [
            { key: "eu", host: "https://europe.albion-online-data.com/api/v2/stats" },
            { key: "us", host: "https://west.albion-online-data.com/api/v2/stats" }
          ];

          const baseIds = JSON.parse(fs.readFileSync(fs.existsSync(idsPath) ? idsPath : idsFallback, "utf8"));
          const tiers = [4, 5, 6, 7, 8];
          const ids = baseIds.flatMap((id) => tiers.map((tier) => `T${tier}_${id}`));

          function formatDate(date) {
            return date.toISOString().slice(0, 10);
          }

          async function fetchPrices(host) {
            const currentMap = new Map();
            for (let i = 0; i < ids.length; i += chunkSize) {
              const slice = ids.slice(i, i + chunkSize);
              const url = `${host}/prices/${slice.join(",")}.json?locations=${encodeURIComponent(cities.join(","))}`;
              const res = await fetch(url);
              if (!res.ok) {
                console.error("Fetch failed", res.status, url);
                continue;
              }
              const data = await res.json();
              for (const row of data) {
                const price = Number(row.sell_price_min || 0);
                if (!price) continue;
                const existing = currentMap.get(row.item_id);
                if (!existing || price < existing.price) {
                  currentMap.set(row.item_id, { price, city: row.city });
                }
              }
              const hasMore = i + chunkSize < ids.length;
              if (hasMore) {
                await new Promise((resolve) => setTimeout(resolve, delayMs));
              }
            }
            return currentMap;
          }

          async function fetchHistoryAverages(host, missingIds) {
            const historyMap = new Map();
            if (!missingIds.length) return historyMap;
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 14);
            const dateParam = `date=${formatDate(startDate)}&end_date=${formatDate(endDate)}&time-scale=24`;

            for (let i = 0; i < missingIds.length; i += historyChunkSize) {
              const slice = missingIds.slice(i, i + historyChunkSize);
              const url = `${host}/history/${slice.join(",")}.json?locations=${encodeURIComponent(cities.join(","))}&${dateParam}`;
              const res = await fetch(url);
              if (!res.ok) {
                console.error("History fetch failed", res.status, url);
                continue;
              }
              const data = await res.json();
              for (const row of data) {
                const series = Array.isArray(row.data) ? row.data : [];
                const values = series
                  .map((entry) => Number(entry.avg_price || 0))
                  .filter((val) => Number.isFinite(val) && val > 0);
                if (!values.length) continue;
                const avg = values.reduce((sum, val) => sum + val, 0) / values.length;
                const existing = historyMap.get(row.item_id);
                if (!existing || avg < existing.price) {
                  historyMap.set(row.item_id, { price: Math.round(avg), city: row.city });
                }
              }
              const hasMore = i + historyChunkSize < missingIds.length;
              if (hasMore) {
                await new Promise((resolve) => setTimeout(resolve, delayMs));
              }
            }
            return historyMap;
          }

          (async () => {
            fs.mkdirSync(outputDir, { recursive: true });
            const now = new Date().toISOString();
            for (const region of regions) {
              const currentMap = await fetchPrices(region.host);
              const missingIds = ids.filter((id) => !currentMap.has(id));
              const historyMap = await fetchHistoryAverages(region.host, missingIds);
              const items = [];
              for (const id of ids) {
                const pick = currentMap.get(id) || historyMap.get(id);
                if (!pick || !pick.price) continue;
                items.push({
                  itemId: id,
                  city: pick.city,
                  price: pick.price
                });
              }
              const payload = {
                generatedAt: now,
                region: region.key,
                city: "ANY",
                count: items.length,
                items
              };
              const outPath = path.join(outputDir, `artefacts-${region.key}.json`);
              fs.writeFileSync(outPath, JSON.stringify(payload));
              console.log(`Wrote ${outPath}: ${items.length} rows`);
            }
          })().catch((err) => {
            console.error(err);
            process.exit(1);
          });
          NODE

      - name: Commit artefact price outputs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain Albion_ProfitChecker/ui/Blackmarket-Crafter/data/artefacts-eu.json Albion_ProfitChecker/ui/Blackmarket-Crafter/data/artefacts-us.json)" ]; then
            git add Albion_ProfitChecker/ui/Blackmarket-Crafter/data/artefacts-eu.json Albion_ProfitChecker/ui/Blackmarket-Crafter/data/artefacts-us.json
            git commit -m "chore: update artefact prices (eu/us)"
          else
            echo "No artefact price changes"
          fi

      - name: Push changes
        if: success()
        run: |
          branch=$(git rev-parse --abbrev-ref HEAD)
          git pull --rebase origin "$branch" || true
          if [ -n "$(git log origin/$(git rev-parse --abbrev-ref HEAD)..HEAD)" ]; then
            git push
          else
            echo "Nichts zu pushen"
          fi
